{% extends 'base.html.twig' %}

{% block title %}{{ session.name }} - Playlist{% endblock %}

{% block body %}
<div class="container-fluid py-4">
    <div class="row">
        <div class="col-lg-8 mx-auto">
            <div class="card mb-4">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div>
                            <h2 class="mb-0">{{ session.name }}</h2>
                            <p class="text-muted mb-0">
                                Code: <span class="badge bg-primary">{{ session.code }}</span> |
                                Participant: <strong>{{ participant.name }}</strong>
                            </p>
                        </div>
                        <a href="{{ path('app_home') }}" class="btn btn-outline-secondary">
                            <i class="bi bi-house"></i> Accueil
                        </a>
                    </div>
                </div>
            </div>

            <div class="row g-4">
                <div class="col-lg-6">
                    <div class="card h-100">
                        <div class="card-header bg-primary text-white">
                            <h5 class="mb-0"><i class="bi bi-search"></i> Rechercher des titres</h5>
                        </div>
                        <div class="card-body">
                            {# Bouton importer playlist Spotify #}
                            <div class="mb-3">
                                <button id="importSpotifyBtn" class="btn btn-success w-100" onclick="handleSpotifyImport()">
                                    <i class="bi bi-spotify"></i> Importer une playlist Spotify
                                </button>
                            </div>

                            <div class="mb-3">
                                <input type="text" id="searchInput" class="form-control form-control-lg"
                                       placeholder="Rechercher un titre ou un artiste...">
                            </div>
                            <div id="searchResults" class="list-group" style="max-height: 400px; overflow-y: auto;">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-lg-6">
                    <div class="card h-100">
                        <div class="card-header bg-success text-white">
                            <div class="d-flex justify-content-between align-items-center">
                                <h5 class="mb-0"><i class="bi bi-music-note-list"></i> Mes titres</h5>
                                <span id="trackCount" class="badge bg-light text-dark">0</span>
                            </div>
                        </div>
                        <div class="card-body">
                            <div id="myTracks" class="list-group mb-3" style="max-height: 350px; overflow-y: auto;">
                            </div>
                            <div class="d-grid gap-2">
                                <button id="validateBtn" class="btn btn-success btn-lg" disabled>
                                    <i class="bi bi-check-circle"></i> Valider ma sélection
                                </button>
                            </div>
                            <div class="text-center mt-3" id="maxTracksInfo"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card mt-4">
                <div class="card-header bg-dark text-white">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="bi bi-list-stars"></i> Playlist générale de la session</h5>
                        <span id="totalTracks" class="badge bg-light text-dark">0 titres</span>
                    </div>
                </div>
                <div class="card-body">
                    <div id="participantStats" class="mb-4">
                    </div>
                    <div class="mt-4">
                        <h6>Exporter vers :</h6>
                        <div class="d-flex gap-2 flex-wrap">
                            <button class="btn btn-success" onclick="exportToService('spotify')">
                                <i class="bi bi-spotify"></i> Spotify
                            </button>
                        </div>
                        <small class="text-muted d-block mt-2">
                            Note: Vous devrez vous connecter à Spotify pour exporter la playlist
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{# Modal pour sélectionner une playlist Spotify #}
<div class="modal fade" id="spotifyPlaylistModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title"><i class="bi bi-spotify"></i> Sélectionner une playlist Spotify</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="spotifyPlaylistContent">
                    <div class="text-center">
                        <div class="spinner-border text-success" role="status">
                            <span class="visually-hidden">Chargement...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{# Modal générique pour les messages (succès/erreur/info) #}
<div class="modal fade" id="messageModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header" id="messageModalHeader">
                <h5 class="modal-title" id="messageModalTitle"></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="messageModalBody"></div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" data-bs-dismiss="modal">OK</button>
            </div>
        </div>
    </div>
</div>

{# Modal de confirmation #}
<div class="modal fade" id="confirmModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="confirmModalTitle">Confirmation</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="confirmModalBody"></div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                <button type="button" class="btn btn-primary" id="confirmModalConfirm">Confirmer</button>
            </div>
        </div>
    </div>
</div>

<script>
const sessionCode = '{{ session.code }}';
let searchTimeout;
let isValidated = false;
let maxTracks = {{ session.maxTracksPerParticipant|default('null') }};

// ========== MODAL HELPERS ==========

function showMessage(message, type = 'info', title = null) {
    const modal = new bootstrap.Modal(document.getElementById('messageModal'));
    const header = document.getElementById('messageModalHeader');
    const titleEl = document.getElementById('messageModalTitle');
    const body = document.getElementById('messageModalBody');

    // Reset classes
    header.className = 'modal-header';

    // Set type-specific styles
    if (type === 'success') {
        header.classList.add('bg-success', 'text-white');
        titleEl.innerHTML = '<i class="bi bi-check-circle-fill me-2"></i>' + (title || 'Succès');
    } else if (type === 'error') {
        header.classList.add('bg-danger', 'text-white');
        titleEl.innerHTML = '<i class="bi bi-exclamation-triangle-fill me-2"></i>' + (title || 'Erreur');
    } else if (type === 'warning') {
        header.classList.add('bg-warning', 'text-dark');
        titleEl.innerHTML = '<i class="bi bi-exclamation-circle-fill me-2"></i>' + (title || 'Attention');
    } else {
        header.classList.add('bg-info', 'text-white');
        titleEl.innerHTML = '<i class="bi bi-info-circle-fill me-2"></i>' + (title || 'Information');
    }

    body.innerHTML = message;
    modal.show();
}

function showConfirm(message, onConfirm, title = 'Confirmation') {
    const modal = new bootstrap.Modal(document.getElementById('confirmModal'));
    const titleEl = document.getElementById('confirmModalTitle');
    const body = document.getElementById('confirmModalBody');
    const confirmBtn = document.getElementById('confirmModalConfirm');

    titleEl.textContent = title;
    body.innerHTML = message;

    // Remove old event listeners by cloning the button
    const newConfirmBtn = confirmBtn.cloneNode(true);
    confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);

    // Add new event listener
    newConfirmBtn.addEventListener('click', function() {
        modal.hide();
        if (onConfirm) onConfirm();
    });

    modal.show();
}

document.getElementById('searchInput').addEventListener('input', function(e) {
    clearTimeout(searchTimeout);
    const query = e.target.value.trim();

    if (query.length < 2) {
        document.getElementById('searchResults').innerHTML = '';
        return;
    }

    searchTimeout = setTimeout(() => searchTracks(query), 500);
});

async function searchTracks(query) {
    try {
        const response = await fetch(`/session/${sessionCode}/search?q=${encodeURIComponent(query)}`);
        const tracks = await response.json();

        const resultsDiv = document.getElementById('searchResults');
        resultsDiv.innerHTML = '';

        if (tracks.length === 0) {
            resultsDiv.innerHTML = '<div class="text-muted p-3">Aucun résultat trouvé</div>';
            return;
        }

        tracks.forEach(track => {
            const item = document.createElement('button');
            item.className = 'list-group-item list-group-item-action d-flex align-items-center';
            item.innerHTML = `
                ${track.cover ? `<img src="${track.cover}" class="me-3" style="width: 50px; height: 50px; object-fit: cover;">` : ''}
                <div class="flex-grow-1">
                    <div class="fw-bold">${track.title}</div>
                    <small class="text-muted">${track.artist}</small>
                </div>
                <i class="bi bi-plus-circle fs-4 text-success"></i>
            `;
            item.onclick = () => addTrack(track);
            resultsDiv.appendChild(item);
        });
    } catch (error) {
        console.error('Erreur de recherche:', error);
    }
}

async function addTrack(track) {
    if (isValidated) {
        showMessage('Vous avez déjà validé votre liste !', 'warning');
        return;
    }

    try {
        const response = await fetch(`/session/${sessionCode}/add-track`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                title: track.title,
                artist: track.artist,
                album: track.album,
                duration: track.duration,
                id: track.id,
                uri: track.uri,
                cover: track.cover
            })
        });

        const result = await response.json();

        if (result.error) {
            showMessage(result.error, 'error');
            return;
        }

        loadMyTracks();
        loadAllTracks();
    } catch (error) {
        console.error('Erreur ajout:', error);
    }
}

async function removeTrack(trackId) {
    if (isValidated) {
        showMessage('Vous avez déjà validé votre liste !', 'warning');
        return;
    }

    try {
        const response = await fetch(`/session/${sessionCode}/remove-track/${trackId}`, {
            method: 'DELETE'
        });

        const result = await response.json();

        if (result.success) {
            loadMyTracks();
            loadAllTracks();
        }
    } catch (error) {
        console.error('Erreur suppression:', error);
    }
}

async function loadMyTracks() {
    try {
        const response = await fetch(`/session/${sessionCode}/my-tracks`);
        const data = await response.json();

        const tracksDiv = document.getElementById('myTracks');
        const countSpan = document.getElementById('trackCount');
        const validateBtn = document.getElementById('validateBtn');
        const maxInfo = document.getElementById('maxTracksInfo');

        isValidated = data.validated;
        countSpan.textContent = data.tracks.length;

        if (maxTracks) {
            maxInfo.innerHTML = `<small class="text-muted">${data.tracks.length} / ${maxTracks} titres</small>`;
        }

        if (data.tracks.length === 0) {
            tracksDiv.innerHTML = '<div class="text-muted p-3 text-center">Aucun titre ajouté</div>';
            validateBtn.disabled = true;
        } else {
            tracksDiv.innerHTML = '';
            data.tracks.forEach(track => {
                const item = document.createElement('div');
                item.className = 'list-group-item d-flex align-items-center';
                item.innerHTML = `
                    ${track.cover ? `<img src="${track.cover}" class="me-3" style="width: 40px; height: 40px; object-fit: cover;">` : ''}
                    <div class="flex-grow-1">
                        <div class="fw-bold">${track.title}</div>
                        <small class="text-muted">${track.artist}</small>
                    </div>
                    ${!isValidated ? `<button class="btn btn-sm btn-danger" onclick="removeTrack(${track.id})">
                        <i class="bi bi-trash"></i>
                    </button>` : ''}
                `;
                tracksDiv.appendChild(item);
            });

            validateBtn.disabled = isValidated;
            if (isValidated) {
                validateBtn.innerHTML = '<i class="bi bi-check-circle-fill"></i> Sélection validée';
                validateBtn.classList.remove('btn-success');
                validateBtn.classList.add('btn-secondary');
            }
        }
    } catch (error) {
        console.error('Erreur chargement:', error);
    }
}

async function loadAllTracks() {
    try {
        const response = await fetch(`/session/${sessionCode}/all-tracks`);
        const data = await response.json();

        const statsDiv = document.getElementById('participantStats');
        const totalTracksSpan = document.getElementById('totalTracks');

        totalTracksSpan.textContent = `${data.total_tracks} titre${data.total_tracks > 1 ? 's' : ''}`;

        if (data.participants.length === 0) {
            statsDiv.innerHTML = '<div class="text-muted p-3 text-center">Aucun participant</div>';
        } else {
            statsDiv.innerHTML = '';
            data.participants.forEach(participant => {
                const item = document.createElement('div');
                item.className = 'mb-2';

                const percentage = participant.max ? (participant.count / participant.max * 100) : 0;
                const progressColor = participant.validated ? 'success' : (percentage >= 100 ? 'warning' : 'info');

                item.innerHTML = `
                    <div class="d-flex justify-content-between align-items-center mb-1">
                        <div>
                            <strong>${participant.name}</strong>
                            ${participant.validated ? '<i class="bi bi-check-circle-fill text-success ms-1" title="Validé"></i>' : ''}
                        </div>
                        <span class="badge bg-${progressColor}">
                            ${participant.count}${participant.max ? '/' + participant.max : ''}
                        </span>
                    </div>
                    ${participant.max ? `
                        <div class="progress" style="height: 8px;">
                            <div class="progress-bar bg-${progressColor}" role="progressbar"
                                 style="width: ${Math.min(percentage, 100)}%"
                                 aria-valuenow="${participant.count}"
                                 aria-valuemin="0"
                                 aria-valuemax="${participant.max}">
                            </div>
                        </div>
                    ` : ''}
                `;
                statsDiv.appendChild(item);
            });
        }
    } catch (error) {
        console.error('Erreur chargement playlist:', error);
    }
}

document.getElementById('validateBtn').addEventListener('click', async function() {
    // Récupérer le nombre actuel de titres
    const currentTracksCount = parseInt(document.getElementById('trackCount').textContent);

    // Construire le message de confirmation
    let confirmMessage = '';

    // Si un maximum est défini et qu'il n'est pas atteint, afficher un gros avertissement
    if (maxTracks && currentTracksCount < maxTracks) {
        confirmMessage = `
            <div class="alert alert-danger mb-3" role="alert">
                <i class="bi bi-exclamation-triangle-fill fs-3 d-block mb-2"></i>
                <h5 class="alert-heading">ATTENTION : SÉLECTION INCOMPLÈTE</h5>
                <p class="mb-0">Vous avez seulement <strong>${currentTracksCount} titre${currentTracksCount > 1 ? 's' : ''}</strong> sur <strong>${maxTracks} maximum autorisés</strong>.</p>
                <p class="mb-0 mt-2">Vous pouvez encore ajouter <strong>${maxTracks - currentTracksCount} titre${(maxTracks - currentTracksCount) > 1 ? 's' : ''}</strong>.</p>
            </div>
            <p><strong>Cette action est définitive.</strong> Vous ne pourrez plus modifier votre sélection après validation.</p>
            <p class="text-muted mb-0">Voulez-vous vraiment valider maintenant ?</p>
        `;
    } else {
        confirmMessage = `
            <p><strong>Cette action est définitive.</strong> Vous ne pourrez plus modifier votre sélection après validation.</p>
            <p class="text-muted mb-0">Êtes-vous sûr de vouloir continuer ?</p>
        `;
    }

    showConfirm(
        confirmMessage,
        async function() {
            try {
                const response = await fetch(`/session/${sessionCode}/validate`, {
                    method: 'POST'
                });

                const result = await response.json();

                if (result.success) {
                    loadMyTracks();
                    showMessage('Votre sélection a été validée !', 'success');
                }
            } catch (error) {
                console.error('Erreur validation:', error);
            }
        },
        'Valider la sélection'
    );
});

function exportToService(service) {
    if (service === 'spotify') {
        exportToSpotify();
    } else {
        showMessage(
            `Pour exporter vers ${service.toUpperCase()}, vous devez configurer les clés API OAuth2.<br><br>Veuillez consulter la documentation pour obtenir un access token et utiliser l'endpoint /export/${service}/${sessionCode}`,
            'info'
        );
    }
}

// ========== SPOTIFY IMPORT/EXPORT ==========

async function handleSpotifyImport() {
    if (isValidated) {
        showMessage('Vous avez déjà validé votre liste !', 'warning');
        return;
    }

    // Vérifier si l'utilisateur est connecté à Spotify
    try {
        const tokenResponse = await fetch('/spotify/auth/token');
        const tokenData = await tokenResponse.json();

        if (!tokenData.authenticated) {
            // Pas connecté, proposer de se connecter
            showConfirm(
                'Vous devez vous connecter à Spotify pour importer une playlist.<br><br>Voulez-vous vous connecter maintenant ?',
                function() {
                    const currentUrl = window.location.pathname;
                    window.location.href = `/spotify/auth/login?return_url=${encodeURIComponent(currentUrl)}`;
                },
                'Connexion Spotify requise'
            );
            return;
        }

        // Connecté, afficher les playlists
        showSpotifyPlaylists(tokenData.access_token);

    } catch (error) {
        console.error('Erreur:', error);
        showMessage('Erreur lors de la vérification de l\'authentification Spotify', 'error');
    }
}

async function showSpotifyPlaylists(accessToken) {
    // Ouvrir le modal
    const modal = new bootstrap.Modal(document.getElementById('spotifyPlaylistModal'));
    modal.show();

    const contentDiv = document.getElementById('spotifyPlaylistContent');
    contentDiv.innerHTML = '<div class="text-center"><div class="spinner-border text-success" role="status"></div><p class="mt-2">Chargement de vos playlists...</p></div>';

    try {
        const response = await fetch('/export/spotify/playlists', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ access_token: accessToken })
        });

        const data = await response.json();

        console.log('Response data:', data);
        console.log('Playlists:', data.playlists);
        console.log('Playlists length:', data.playlists ? data.playlists.length : 0);

        if (!data.success || !data.playlists || data.playlists.length === 0) {
            console.log('No playlists condition triggered');
            contentDiv.innerHTML = '<div class="alert alert-warning">Aucune playlist trouvée sur votre compte Spotify.<br><small>Détails: success=' + data.success + ', playlists=' + (data.playlists ? data.playlists.length : 'null') + '</small></div>';
            return;
        }

        // Afficher les playlists
        let html = '<div class="list-group">';
        data.playlists.forEach(playlist => {
            html += `
                <button class="list-group-item list-group-item-action d-flex align-items-center"
                        onclick="importPlaylist('${playlist.id}', '${accessToken}')">
                    ${playlist.image ? `<img src="${playlist.image}" class="me-3" style="width: 60px; height: 60px; object-fit: cover; border-radius: 4px;">` : ''}
                    <div class="flex-grow-1">
                        <div class="fw-bold">${escapeHtml(playlist.name)}</div>
                        <small class="text-muted">${playlist.tracks_total} titre${playlist.tracks_total > 1 ? 's' : ''}</small>
                        ${playlist.description ? `<br><small class="text-muted">${escapeHtml(playlist.description).substring(0, 100)}</small>` : ''}
                    </div>
                    <i class="bi bi-download fs-4 text-success"></i>
                </button>
            `;
        });
        html += '</div>';

        contentDiv.innerHTML = html;

    } catch (error) {
        console.error('Erreur:', error);
        contentDiv.innerHTML = '<div class="alert alert-danger">Erreur lors du chargement des playlists.</div>';
    }
}

async function importPlaylist(playlistId, accessToken) {
    showConfirm(
        'Importer cette playlist ? Les titres seront ajoutés à votre sélection.',
        async function() {
            // Fermer le modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('spotifyPlaylistModal'));
            modal.hide();

            // Afficher un indicateur de chargement
            const btn = document.getElementById('importSpotifyBtn');
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Import en cours...';

            try {
                const response = await fetch(`/export/spotify/import/${sessionCode}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        access_token: accessToken,
                        playlist_id: playlistId
                    })
                });

                const result = await response.json();

                if (result.error) {
                    showMessage('Erreur: ' + result.error, 'error');
                } else {
                    showMessage(
                        `${result.tracks_imported} titre${result.tracks_imported > 1 ? 's importés' : ' importé'} sur ${result.tracks_total} !`,
                        'success',
                        'Import réussi'
                    );
                    loadMyTracks();
                    loadAllTracks();
                }

            } catch (error) {
                console.error('Erreur:', error);
                showMessage('Erreur lors de l\'import de la playlist', 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        },
        'Importer la playlist'
    );
}

async function exportToSpotify() {
    try {
        const tokenResponse = await fetch('/spotify/auth/token');
        const tokenData = await tokenResponse.json();

        if (!tokenData.authenticated) {
            showConfirm(
                'Vous devez vous connecter à Spotify pour exporter la playlist.<br><br>Voulez-vous vous connecter maintenant ?',
                function() {
                    const currentUrl = window.location.pathname;
                    window.location.href = `/spotify/auth/login?return_url=${encodeURIComponent(currentUrl)}`;
                },
                'Connexion Spotify requise'
            );
            return;
        }

        showConfirm(
            'Créer une playlist sur votre compte Spotify avec tous les titres de cette session ?',
            async function() {
                try {
                    const response = await fetch(`/export/spotify/${sessionCode}`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ access_token: tokenData.access_token })
                    });

                    const result = await response.json();

                    if (result.success) {
                        showMessage(
                            `Playlist créée avec ${result.tracks_added} titres !`,
                            'success',
                            'Export réussi'
                        );
                        if (result.playlist_url) {
                            window.open(result.playlist_url, '_blank');
                        }
                    } else {
                        showMessage('Erreur: ' + result.error, 'error');
                    }
                } catch (error) {
                    console.error('Erreur:', error);
                    showMessage('Erreur lors de l\'export vers Spotify', 'error');
                }
            },
            'Exporter vers Spotify'
        );

    } catch (error) {
        console.error('Erreur:', error);
        showMessage('Erreur lors de l\'export vers Spotify', 'error');
    }
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// ========== INITIALISATION ==========

loadMyTracks();
loadAllTracks();

setInterval(loadAllTracks, 5000);
</script>
{% endblock %}
